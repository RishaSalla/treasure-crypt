// Ø§Ù„Ø­Ø¬Ù… Ù…Ø·Ø§Ø¨Ù‚ Ù„Ù…Ù„Ù CSS
const TILE_SIZE = 35; 

const container = document.getElementById('game-container');
const levelDisplay = document.getElementById('level-display');
const movesDisplay = document.getElementById('moves-display');

let currentLevelIndex = 0;
let currentMap = []; 
let playerPos = {x: 0, y: 0};
let moves = 0;

// Ù…ØªØºÙŠØ±Ø§Øª Ø§Ù„Ù„Ù…Ø³
let touchStartX = 0;
let touchStartY = 0;

window.onload = function() {
    loadLevel(currentLevelIndex);
    document.addEventListener('keydown', handleInput);
    
    // ØªÙØ¹ÙŠÙ„ Ø§Ù„Ù„Ù…Ø³ Ù„Ù„Ø¬ÙˆØ§Ù„
    container.addEventListener('touchstart', handleTouchStart, {passive: false});
    container.addEventListener('touchend', handleTouchEnd, {passive: false});
};

function loadLevel(index) {
    if (index >= levels.length) {
        alert("ðŸŽ‰ Ù…Ø¨Ø±ÙˆÙƒ! Ø®ØªÙ…Øª Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ø±Ø§Ø­Ù„!");
        currentLevelIndex = 0;
        index = 0;
    }
    
    // Ù†Ø³Ø® Ø§Ù„Ù…Ø±Ø­Ù„Ø©
    currentMap = JSON.parse(JSON.stringify(levels[index]));
    
    moves = 0;
    updateUI();
    findPlayerStart();
    render();
}

function findPlayerStart() {
    for (let y = 0; y < currentMap.length; y++) {
        for (let x = 0; x < currentMap[y].length; x++) {
            if (currentMap[y][x] === 4) {
                playerPos = {x: x, y: y};
                currentMap[y][x] = 0; // ØªØ­ÙˆÙŠÙ„ Ù…ÙƒØ§Ù†Ù‡ Ù„Ø£Ø±Ø¶ÙŠØ©
            }
        }
    }
}

function resetLevel() {
    loadLevel(currentLevelIndex);
}

function updateUI() {
    if(levelDisplay) levelDisplay.innerText = currentLevelIndex + 1;
    if(movesDisplay) movesDisplay.innerText = moves;
}

// === Ø¯Ø§Ù„Ø© Ø§Ù„Ø±Ø³Ù… Ø§Ù„Ù…ØµØ­Ø­Ø© (ØªØ­Ø³Ø¨ Ø§Ù„Ø¹Ø±Ø¶ Ø§Ù„ØµØ­ÙŠØ­) ===
function render() {
    container.innerHTML = '';
    
    // 1. Ø­Ø³Ø§Ø¨ Ø¹Ø±Ø¶ Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø¨Ù†Ø§Ø¡Ù‹ Ø¹Ù„Ù‰ Ø£Ø·ÙˆÙ„ ØµÙ (ÙˆÙ„ÙŠØ³ Ø§Ù„ØµÙ Ø§Ù„Ø£ÙˆÙ„ ÙÙ‚Ø·)
    let maxWidth = 0;
    for(let row of currentMap) {
        if(row.length > maxWidth) maxWidth = row.length;
    }
    
    container.style.width = maxWidth * TILE_SIZE + 'px';
    container.style.height = currentMap.length * TILE_SIZE + 'px';

    for (let y = 0; y < currentMap.length; y++) {
        for (let x = 0; x < currentMap[y].length; x++) {
            let type = currentMap[y][x];
            
            // Ù„Ø§ Ù†Ø±Ø³Ù… Ø§Ù„ÙØ±Ø§Øº Ø§Ù„Ø®Ø§Ø±Ø¬ÙŠ (Ø±Ù‚Ù… 0 Ø®Ø§Ø±Ø¬ Ø§Ù„Ø¬Ø¯Ø±Ø§Ù†) Ù„ØªÙˆÙÙŠØ± Ø§Ù„Ø£Ø¯Ø§Ø¡
            // Ù„ÙƒÙ† Ù‡Ù†Ø§ Ø³Ù†Ø±Ø³Ù… ÙƒÙ„ Ø´ÙŠØ¡ Ù„Ø¶Ù…Ø§Ù† Ø§Ù„Ø´ÙƒÙ„
            
            let tile = document.createElement('div');
            tile.classList.add('cell');
            tile.style.left = x * TILE_SIZE + 'px';
            tile.style.top = y * TILE_SIZE + 'px';

            // Ø¥Ø¶Ø§ÙØ© Ø§Ù„ÙƒÙ„Ø§Ø³Ø§Øª Ø­Ø³Ø¨ Ø§Ù„Ø±Ù‚Ù…
            if (type === 1) tile.classList.add('wall');
            else if (type === 3) tile.classList.add('goal');
            else tile.classList.add('floor');

            // Ø±Ø³Ù… Ø§Ù„ØµÙ†Ø§Ø¯ÙŠÙ‚
            if (type === 2 || type === 5) {
                let box = document.createElement('div');
                box.classList.add('cell', 'box');
                box.style.left = x * TILE_SIZE + 'px';
                box.style.top = y * TILE_SIZE + 'px';
                
                if (type === 5) {
                    box.classList.add('completed');
                    tile.classList.add('goal'); // Ø§Ù„ØªØ£ÙƒØ¯ Ù…Ù† Ø±Ø³Ù… Ø§Ù„Ù‡Ø¯Ù ØªØ­Øª Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
                }
                container.appendChild(box);
            }
            
            container.appendChild(tile);
        }
    }

    // Ø±Ø³Ù… Ø§Ù„Ù„Ø§Ø¹Ø¨
    let player = document.createElement('div');
    player.classList.add('cell', 'player');
    player.style.left = playerPos.x * TILE_SIZE + 'px';
    player.style.top = playerPos.y * TILE_SIZE + 'px';
    container.appendChild(player);
}

// Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„ÙƒÙŠØ¨ÙˆØ±Ø¯
function handleInput(e) {
    // Ù…Ù†Ø¹ ØªØ­Ø±ÙŠÙƒ Ø§Ù„ØµÙØ­Ø© Ø¨Ø§Ù„Ø£Ø³Ù‡Ù…
    if(["ArrowUp","ArrowDown","ArrowLeft","ArrowRight"].indexOf(e.code) > -1) {
        e.preventDefault();
    }

    let dx = 0, dy = 0;
    if (e.key === 'ArrowUp') dy = -1;
    else if (e.key === 'ArrowDown') dy = 1;
    else if (e.key === 'ArrowLeft') dx = -1;
    else if (e.key === 'ArrowRight') dx = 1;
    else return;

    moveLogic(dx, dy);
}

// Ø§Ù„ØªØ­ÙƒÙ… Ø¨Ø§Ù„Ù„Ù…Ø³
function handleTouchStart(e) {
    e.preventDefault();
    touchStartX = e.changedTouches[0].screenX;
    touchStartY = e.changedTouches[0].screenY;
}

function handleTouchEnd(e) {
    e.preventDefault();
    let touchEndX = e.changedTouches[0].screenX;
    let touchEndY = e.changedTouches[0].screenY;
    handleSwipe(touchStartX, touchStartY, touchEndX, touchEndY);
}

function handleSwipe(startX, startY, endX, endY) {
    let diffX = endX - startX;
    let diffY = endY - startY;
    if (Math.abs(diffX) < 30 && Math.abs(diffY) < 30) return; // Ø³Ø­Ø¨Ø© Ù‚ØµÙŠØ±Ø© Ø¬Ø¯Ø§Ù‹

    let dx = 0, dy = 0;
    if (Math.abs(diffX) > Math.abs(diffY)) {
        dx = diffX > 0 ? 1 : -1;
    } else {
        dy = diffY > 0 ? 1 : -1;
    }
    moveLogic(dx, dy);
}

// Ù…Ù†Ø·Ù‚ Ø§Ù„Ø­Ø±ÙƒØ© Ø§Ù„Ù…Ø´ØªØ±Ùƒ
function moveLogic(dx, dy) {
    let nextX = playerPos.x + dx;
    let nextY = playerPos.y + dy;
    
    // Ø­Ù…Ø§ÙŠØ© Ù…Ù† Ø§Ù„Ø®Ø±ÙˆØ¬ Ø®Ø§Ø±Ø¬ Ø§Ù„Ù…ØµÙÙˆÙØ©
    if (!currentMap[nextY] || typeof currentMap[nextY][nextX] === 'undefined') return;

    let nextTile = currentMap[nextY][nextX];

    // 1. Ø§Ù„Ø¬Ø¯Ø§Ø±
    if (nextTile === 1) return;

    // 2. Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
    if (nextTile === 2 || nextTile === 5) {
        let afterBoxX = nextX + dx;
        let afterBoxY = nextY + dy;
        
        if (!currentMap[afterBoxY] || typeof currentMap[afterBoxY][afterBoxX] === 'undefined') return;
        
        let afterBoxTile = currentMap[afterBoxY][afterBoxX];

        if (afterBoxTile === 0 || afterBoxTile === 3) {
            // ØªØ­Ø±ÙŠÙƒ Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚
            currentMap[afterBoxY][afterBoxX] = (afterBoxTile === 3) ? 5 : 2;
            
            // ØªØ­Ø¯ÙŠØ« Ù…ÙƒØ§Ù† Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ø§Ù„Ù‚Ø¯ÙŠÙ…
            if (nextTile === 5) currentMap[nextY][nextX] = 3;
            else currentMap[nextY][nextX] = 0;
            
            nextTile = currentMap[nextY][nextX]; 
        } else {
            return; // Ø§Ù„ØµÙ†Ø¯ÙˆÙ‚ Ù…Ø³Ø¯ÙˆØ¯
        }
    }

    // 3. ØªØ­Ø±ÙŠÙƒ Ø§Ù„Ù„Ø§Ø¹Ø¨
    playerPos.x = nextX;
    playerPos.y = nextY;
    moves++;
    
    updateUI();
    render();
    checkWin();
}

function checkWin() {
    let remainingBoxes = 0;
    for (let row of currentMap) {
        for (let cell of row) {
            if (cell === 2) remainingBoxes++;
        }
    }

    if (remainingBoxes === 0) {
        setTimeout(() => {
            alert("âœ¨ Ø£Ø­Ø³Ù†Øª! Ø§Ù„Ù…Ø±Ø­Ù„Ø© Ø§Ù„ØªØ§Ù„ÙŠØ©...");
            currentLevelIndex++;
            loadLevel(currentLevelIndex);
        }, 100);
    }
}
